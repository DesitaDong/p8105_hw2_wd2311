---
title: "p8105_hw2_wd2311"
author: "wd2311"
date: "2025-10-02"
output: github_document
---
```{r}
library(tidyverse)
library(readxl)
library(janitor)

```



# Problem 1
Read and clean the data in pols-month.csv
```{r}
pols_df = read_csv(file = "./data/pols-month.csv")
pols_df = 
  janitor::clean_names(pols_df) |>
  separate(mon, into = c("year", "month_num", "day"), convert = TRUE) |>
  mutate(
    month = tolower(month.name[month_num]),
    president = if_else(prez_gop == 1, "gop", "dem")
  ) |>
  select(year, month, president, starts_with("gov"), starts_with("sen"),
         starts_with("rep"), matches("^prez_"), everything()) |>
  select(-prez_gop, -prez_dem, -day, -month_num) |>
  arrange(year, match(month, tolower(month.name)))

```

Read and clean the data in snp.csv
```{r}
snp_df <- read_csv(file.path("./data/snp.csv")) |>
  janitor::clean_names() |>
  mutate(date = mdy(date)) |>
  transmute(
    year  = year(date),
    month = tolower(month(date, label = TRUE, abbr = FALSE)),
    close
  ) |>
  arrange(year, match(month, tolower(month.name)))

```


tidy the unemployment data
```{r}
unemp_df <- read_csv(file.path("./data/unemployment.csv")) |>
  janitor::clean_names() |>
  pivot_longer(
    cols = -year,
    names_to = "month",
    values_to = "unemployment"
  ) |>
  mutate(
    month = tolower(month.name[match(str_to_title(month), month.abb)])
  ) |>
  arrange(year, match(month, tolower(month.name)))
```

Join the datasets by merging snp into pols, and merging unemployment into the result.
```{r}
pols_snp_df = 
  left_join(pols_df, snp_df, by = c("year", "month"))

merged_df =
  left_join(pols_snp_df, unemp_df, by = c("year", "month"))
dim(merged_df)
summary(select(merged_df, year, month, close, unemployment, president))
```
Explain briefly what each dataset contained, and describe the resulting dataset (e.g. give the dimension, range of years, and names of key variables).

pols_month_df provides monthly counts of national political officeholders and a 
president indicator; snp_.csv_df contains S&P 500 closing values by date.
unemp_loyment.csv_df reports monthly U.S. unemployment rates in wide form.

After left-joining S&P into pols and then unemployment into the result, the 
final merged dataset has 822 rows and 11 columns, spans 1947 to 2015, and its 
key variables include year, month, president, close, unemployment, and 6 
variables on the parties of national politicians.


# Problem 2
Read and clean the Mr. Trash Wheel sheet:
```{r}
MrTW_df = 
  read_excel("./data/Trash Wheel Collection.xlsx", sheet = "Mr. Trash Wheel", 
             skip = 1,na = c(".", "NA", ""))|>
  clean_names() |>
  filter(!is.na(dumpster)) |>
  mutate(
    sports_balls = as.integer(round(sports_balls)),
    wheel = "Mr. Trash Wheel",
    )|>
  select(dumpster, wheel, everything(), where(~!all(is.na(.)))) 
```

Read and clean the Professor Trash Wheel sheet:
```{r}
ProfTW_df = 
  read_excel("./data/Trash Wheel Collection.xlsx", sheet = "Professor Trash Wheel", 
             skip = 1,na = c(".", "NA", ""))|>
  clean_names() |>
  filter(!is.na(dumpster)) |>
  mutate(
    wheel = "Professor Trash Wheel",
    )|>
  select(dumpster, wheel, everything(), ) 

```


Read and clean the Professor Gwynnda sheet:
```{r}
Gwynns_df = 
  read_excel("./data/Trash Wheel Collection.xlsx", sheet = "Gwynns Falls Trash Wheel", 
             skip = 1,na = c(".", "NA", ""))|>
  clean_names() |>
  filter(!is.na(dumpster)) |>
  mutate(
    wheel = "Professor Trash Wheel",
    )|>
  select(dumpster, wheel, everything(), ) 

```

Merge the sheets
```{r}
std_keys <- function(df) {
  df |>
    mutate(
      year  = as.integer(year),
      month = case_when(
        is.numeric(month) ~ tolower(month.name[pmax(1, pmin(12, month))]),
        TRUE              ~ tolower(as.character(month))
      )
    )
}

MrTW_df   <- std_keys(MrTW_df)
ProfTW_df <- std_keys(ProfTW_df)
Gwynns_df <- std_keys(Gwynns_df)

all_df <- bind_rows(MrTW_df, ProfTW_df, Gwynns_df)

prof_total_weight_tons <- all_df |>
  filter(wheel == "Professor Trash Wheel") |>
  summarize(total = sum(weight_tons, na.rm = TRUE)) |>
  pull()

gwyn_cigs_jun_2022 <- all_df |>
  filter(wheel == "Gwynnda Trash Wheel", year == 2022, month == "june") |>
  summarize(total = sum(cigarette_butts, na.rm = TRUE)) |>
  pull()

dim(all_df)
names(all_df)

```

Write a paragraph about these data
After cleaning and combining the three Trash Wheel datasets, the resulting tidy data frame contains 
**`r nrow(all_df)` observations** and **`r ncol(all_df)` variables**. Each row corresponds to a dumpster 
collection event, and key variables include the **date of collection** (`date`, `year`, `month`), the 
**total weight of trash collected** (`weight_tons`), the **volume** (`volume_cubic_yards`), and counts of 
specific items such as `plastic_bottles`, `polystyrene`, `cigarette_butts`, and `sports_balls`. An 
additional variable `wheel` indicates which device (Mr. Trash Wheel, Professor Trash Wheel, or Gwynnda) 
collected the trash.  

Based on the available data, **Professor Trash Wheel** collected a total of 
**`r scales::number(prof_total_weight_tons, accuracy = 0.01)` tons** of trash. In **June 2022**, 
**Gwynnda** collected **`r scales::comma(gwyn_cigs_jun_2022)` cigarette butts**.



# Problem 3
Import and tidy the data
```{r}
zip_path  <- "data/Zip Codes.csv"
zori_path <- "data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv"

zip_lu =
  read_csv(zip_path) |>
  clean_names() |>
  mutate(zip_code = as.character(zip_code)) |>
  rename(
    borough     = county,
    neighborhood = neighborhood  
  ) |>
  select(zip_code, borough, neighborhood)

zori_long <- read_csv(zori_path) |>
  clean_names() |>
  mutate(region_name = as.character(region_name)) |>
  pivot_longer(
    cols = starts_with("x"),     
    names_to = "date_chr",
    values_to = "zori"
  ) |>
  mutate(
    date = as.Date(gsub("^x", "", gsub("_", "-", date_chr))),
    .keep = "unused"
  ) |>
  arrange(region_name, date)
```
merge and describe the resulting tidy dataset
```{r}
zori_merged <- zori_long |>
  left_join(zip_lu, by = c("region_name" = "zip_code")) |>
  relocate(region_name, borough, neighborhood, date, zori)

total_obs  <- nrow(zori_merged)
n_zip      <- n_distinct(zori_merged$region_name)
n_nh       <- n_distinct(na.omit(zori_merged$neighborhood))

summary_list <- list(
  total_observations   = total_obs,
  unique_zip_codes     = n_zip,
  unique_neighborhoods = n_nh
)
print(summary_list)
```
Description：
total_observations：17516. unique_zip_codes: 149.unique_neighborhoods = 42.


ZIPs that are in the ZIP file but not in Zillow
```{r}
zips_in_zip  <- zip_lu |> distinct(zip_code)
zips_in_zori <- zori_long |> distinct(region_name) |> rename(zip_code = region_name)

missing_zip <- zips_in_zip |> anti_join(zips_in_zori, by = "zip_code")
n_missing <- nrow(missing_zip)
cat("ZIPs present in ZIP file but missing in Zillow:", n_missing, "\n")
```

Description：
171 ZIP codes appear in the ZIP code file but not in the Zillow rental dataset.
for exmaples:
10499 (Bronx GPO) is special-purpose or PO-box ZIPs without housing.
11371 (LaGuardia) is airport ZIPs, not residential.
10550 (Mount Vernon) is outside NYC’s five boroughs.


COVID dip Jan 2021 vs Jan 2020
```{r}
jan_2020 <- zori_merged |>
  filter(date == as.Date("2020-01-31")) |>
  select(region_name, zori_2020 = zori, borough, neighborhood)

jan_2021 <- zori_merged |>
  filter(date == as.Date("2021-01-31")) |>
  select(region_name, zori_2021 = zori)

delta_2020_2021 <- jan_2020 |>
  inner_join(jan_2021, by = "region_name") |>
  mutate(change = zori_2021 - zori_2020) |>
  arrange(change)

top10_drop <- delta_2020_2021 |>
  slice_head(n = 10)

print(top10_drop, n = 10)
```




